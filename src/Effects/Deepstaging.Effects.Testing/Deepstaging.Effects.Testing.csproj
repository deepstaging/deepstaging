<!-- SPDX-FileCopyrightText: 2024-present Deepstaging -->
<!-- SPDX-License-Identifier: RPL-1.5 -->
<Project Sdk="Microsoft.NET.Sdk">
    <!--
        Deepstaging.Effects.Testing NuGet Package
        
        This is the main entry point that bundles everything needed to use Deepstaging.Effects.Testing:
        - Test runtime attribute (this project)
        - Source generators (Deepstaging.Effects.Testing.Generators)
        - Analyzers (Deepstaging.Effects.Testing.Analyzers)
        - Code fixes (Deepstaging.Effects.Testing.CodeFixes)
        
        Consumers just need to reference this single package:
        <PackageReference Include="Deepstaging.Effects.Testing" Version="1.0.0" />
    -->

    <PropertyGroup>
        <TargetFrameworks>netstandard2.0;net10.0</TargetFrameworks>
        <LangVersion>latest</LangVersion>
        <Nullable>enable</Nullable>
        <GenerateDocumentationFile>true</GenerateDocumentationFile>
        <IsPackable>true</IsPackable>
        
        <!-- 
            Suppress NU5128: We deliberately bundle libs for multiple TFMs.
            This is intentional for a package that bundles generators.
        -->
        <NoWarn>$(NoWarn);NU5128</NoWarn>
        
        <!-- 
            Enable embedded sources for consumer debugging.
            Sources are embedded directly in the DLL via DebugType=embedded in Build.SourceLink.props.
        -->
        
        <!-- Package metadata -->
        <PackageId>Deepstaging.Effects.Testing</PackageId>
        <Title>Deepstaging.Effects.Testing</Title>
        <Description>Test helpers for Deepstaging.Effects. Generates test runtime implementations with configurable service mocks.</Description>
        <PackageTags>deepstaging;effects;testing;source-generator;functional;csharp</PackageTags>
        <RootNamespace>Deepstaging</RootNamespace>
        

    </PropertyGroup>

    <!-- 
        Consumers need Deepstaging.Effects for the runtime attributes ([Uses], [Runtime], etc.)
        that the testing generators read. This ProjectReference flows as a PackageReference at pack time.
    -->
    <ItemGroup>
        <ProjectReference Include="..\Deepstaging.Effects\Deepstaging.Effects.csproj" />
    </ItemGroup>

    <!-- 
        Build props file that injects dependencies into consuming projects.
        This is imported automatically when a project references this package.
    -->
    <ItemGroup>
        <None Include="build\Deepstaging.Effects.Testing.props" Pack="true" PackagePath="build" />
    </ItemGroup>

    <!-- 
        Package structure:
        
        lib/netstandard2.0/
            Deepstaging.Effects.Testing.dll             (attribute - for netstandard2.0 consumers)
            
        lib/net10.0/
            Deepstaging.Effects.Testing.dll             (attribute - for net10.0 consumers)
            
        analyzers/dotnet/cs/
            Deepstaging.Effects.Testing.Generators.dll
            Deepstaging.Effects.Testing.Analyzers.dll
            Deepstaging.Effects.Testing.CodeFixes.dll
            Deepstaging.Effects.Testing.dll             (generator dependency)
            Deepstaging.Effects.Testing.Projection.dll  (generator dependency)
            Deepstaging.Effects.dll                     (generator dependency - for reading [Uses]/[Runtime])
            Deepstaging.Effects.Projection.dll          (generator dependency - for querying runtime model)
            Deepstaging.Roslyn.dll                      (generator dependency)
            Deepstaging.Roslyn.Workspace.dll            (codefix dependency)
    -->

    <PropertyGroup>
        <BundleArtifactsPath>$(MSBuildThisFileDirectory)..</BundleArtifactsPath>
    </PropertyGroup>

    <!-- Analyzers and generators in analyzers folder (with PDBs for debugging) -->
    <ItemGroup>
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Testing.Generators.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        
        <!-- Generator dependencies (copied from Generators output) -->
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Testing.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Testing.Projection.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Projection.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Generators/bin/$(Configuration)/netstandard2.0/Deepstaging.Roslyn.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />

        <!-- Analyzers -->
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.Analyzers/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Testing.Analyzers.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />

        <!-- Code fixes -->
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.CodeFixes/bin/$(Configuration)/netstandard2.0/Deepstaging.Effects.Testing.CodeFixes.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
        <None Include="$(BundleArtifactsPath)/Deepstaging.Effects.Testing.CodeFixes/bin/$(Configuration)/netstandard2.0/Deepstaging.Roslyn.Workspace.dll"
              Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false" />
    </ItemGroup>

</Project>
