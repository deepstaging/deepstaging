// <auto-generated/>
// SPDX-License-Identifier: RPL-1.5
// Copyright (c) Deepstaging contributors. All rights reserved.
// Licensed under the Reciprocal Public License 1.5 (RPL-1.5).
// See LICENSE file in the project root for full license information.
#nullable enable
using Microsoft.Extensions.DependencyInjection;
using OpenTelemetry.Metrics;
using OpenTelemetry.Trace;
using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;

namespace TestApp;
/// <summary>
/// Provides dependency injection bootstrapping for the <c>Runtime</c> runtime.
/// </summary>
public static class RuntimeBootstrapper
{
    /// <summary>
    /// Registers the <c>Runtime</c> runtime and its dependencies with the service collection.
    /// </summary>
    /// <param name="services">The service collection to add the runtime to.</param>
    /// <param name="configure">An optional delegate to configure runtime options such as tracing and logging.</param>
    /// <returns>The service collection for fluent chaining.</returns>
    public static global::Microsoft.Extensions.DependencyInjection.IServiceCollection AddRuntime(this global::Microsoft.Extensions.DependencyInjection.IServiceCollection services, global::System.Action<RuntimeOptions>? configure = null)
    {
        var options = new RuntimeOptions();
        configure?.Invoke(options);
        services.AddScoped(sp =>
        {
            var emailService = sp.GetRequiredService<global::TestApp.IEmailService>();
            var slackService = sp.GetRequiredService<global::TestApp.ISlackService>();
            var loggerFactory = options.Logging ? sp.GetRequiredService<global::Microsoft.Extensions.Logging.ILoggerFactory>() : null;
            return new TestApp.Runtime(emailService, slackService, loggerFactory);
        });
        if (options.Tracing)
        {
            services.AddOpenTelemetry().WithTracing(tracing => tracing.AddSource("TestApp.EmailService").AddSource("TestApp.SlackService"));
        }

        if (options.Metrics)
        {
            services.AddSingleton(new global::Deepstaging.Effects.EffectMetrics("TestApp.Runtime"));
            services.AddOpenTelemetry().WithMetrics(metrics => metrics.AddMeter("Deepstaging.Effects"));
        }

        return services;
    }

    /// <summary>
    /// Configuration options for bootstrapping the <c>Runtime</c> runtime.
    /// </summary>
    public sealed class RuntimeOptions
    {
        /// <summary>
        /// Gets or sets whether OpenTelemetry tracing is enabled for effect instrumentation.
        /// </summary>
        public bool Tracing { get; set; }
        /// <summary>
        /// Gets or sets whether OpenTelemetry metrics are enabled for effect operations.
        /// </summary>
        public bool Metrics { get; set; }
        /// <summary>
        /// Gets or sets whether structured logging is enabled for effect instrumentation.
        /// </summary>
        public bool Logging { get; set; }

        /// <summary>
        /// Enables OpenTelemetry tracing for instrumented effect methods.
        /// </summary>
        /// <returns>This options instance for fluent chaining.</returns>
        public RuntimeOptions EnableTracing()
        {
            Tracing = true;
            return this;
        }

        /// <summary>
        /// Enables OpenTelemetry metrics for effect operations.
        /// </summary>
        /// <returns>This options instance for fluent chaining.</returns>
        public RuntimeOptions EnableMetrics()
        {
            Metrics = true;
            return this;
        }

        /// <summary>
        /// Enables structured logging for instrumented effect methods.
        /// </summary>
        /// <returns>This options instance for fluent chaining.</returns>
        public RuntimeOptions EnableLogging()
        {
            Logging = true;
            return this;
        }
    }
}